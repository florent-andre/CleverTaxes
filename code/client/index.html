<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="shortcut icon" href="../../docs-assets/ico/favicon.png">

    <title>Starter Template for Bootstrap</title>

	<!-- Latest compiled and minified CSS -->
	<link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.0.2/css/bootstrap.min.css">
	
	  <style type="text/css">
	  
		  body {
			  padding-top: 50px;
			}
			.starter-template {
			  padding: 40px 15px;
			  text-align: center;
			}
	  
	  </style>
	
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->
  </head>

  <body>

    <div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">Project name</a>
        </div>
        <div class="collapse navbar-collapse">
          <ul class="nav navbar-nav">
            <li class="active"><a href="#">Home</a></li>
            <li><a href="#about">About</a></li>
            <li><a href="#contact">Contact</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </div>

    <div class="container">

      <div class="starter-template">
        <h1>Bootstrap starter template</h1>
        <p class="lead">Use this document as a way to quickly start any new project.<br> All you get is this text and a mostly barebones HTML document.</p>
      </div>

    </div><!-- /.container -->


    
    <!-- Jquery -->
    <script src="https://code.jquery.com/jquery-1.10.2.min.js"></script>
	<!-- Bootstrap -->
	<script src="http://netdna.bootstrapcdn.com/bootstrap/3.0.2/js/bootstrap.min.js"></script>
    
  </body>
</html>

<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
    	<title>Your public money in your hand</title>
	    
	    <link rel="icon" type="image/x-icon" href="../resources/images/favicon.ico" />
	    
	    
		<link rel="stylesheet" type="text/css" media="all" href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css" />
		
	    <!-- header and footer -->
		<style type="text/css" title="currentStyle">
		    @import "resources/css/demo_table.css";
			@import "resources/css/propertiesDisplay.css";
		</style>
	    
	    <style type="text/css">
			.chart div {
			  font: 10px sans-serif;
			  background-color: steelblue;
			  text-align: right;
			  padding: 3px;
			  margin: 1px;
			  color: white;
			}
			
				.chart2 div {
			  font: 10px sans-serif;
			  background-color: steelblue;
			  text-align: right;
			  padding: 3px;
			  margin: 1px;
			  color: white;
			}
					  
				.chart2 div.my {
			  background-color: green;
			}
			
			.chart2 div.state {
			  background-color: steelblue;
			}	  	  
	    </style>
	    
	    <link rel="stylesheet" type="text/css" href="resources/css/style.css" />
	    
		<!-- End styles -->
		
		<script type="text/javascript" src="resources/js/array.js"></script>
		
		<script type="text/javascript" src="http://d3js.org/d3.v3.min.js"></script>
		
	    <!-- TODO: extract commons libs from import -->
	    <script type="text/javascript" src="resources/js/libs/jquery-1.7.1.min.js"></script>
	    <script type="text/javascript" src="http://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>
	    
	    <!-- select2 dependencies -->
		<script type="text/javascript" src="resources/js/libs/select2/select2.js"></script>
		<link rel="stylesheet" href="resources/js/libs/select2/select2.css" type="text/css" media="screen" />
		
		<!-- mock datas -->
		<script type="text/javascript" src="./data/rawData.js"></script>
		<script type="text/javascript" src="./data/dataInit.js"></script>
		<script type="text/javascript" src="./data/dataInit2.js"></script>
		<script type="text/javascript" src="./data/dataInit3.js"></script>
	    
	    
	    <script type="text/javascript">
	    
	    	//Question to ask on ml.
	    	// y(d.amount) give the y value, but how I can manage the inverse function ? From y position, get the amount ? 
	    	//will be really usefull for calculation during drag and drop
	    	
	    	$(document).ready(function(){
	    		
	    		var taxAmount;
	    		var x;
	    		
	    		var dfd = $.Deferred();
	    		
	    		$("#valid").click(function(){
	    			taxAmount = +$("#taxamount").attr("value");
	    			
	  	    	 	dfd.resolve();
	    		});


	///**************************************
	    		//**************** Personnal version
	    		
		$.when(dfd.promise()).then(function(){
			
			
			function print( /* {data : d, source : "sourceName"}*/){
				
				var unassignied;
				
				var args = Array.slice(arguments);
				
				//prepare data structure and add functions.

				//data transformation add the source attribute to objects
				args.forEach(function(d,i){
					
					
					
					Object.defineProperty(d, "unassignied", {
						value : null,
						writable : true,
						enumerable : false,
						configurable : false});
					
					
					d.data.forEach(function(a,j){
						
						//var percentageSav = new Integer(a.percentage);
						
						Object.defineProperty(a, "_parent", {
							value : d,
							writable : false,
							enumerable : false,
							configurable : false});
						
						Object.defineProperty(a, "_amount", {
							value : 0,
							writable : true,
							enumerable : false,
							configurable : false});
						
						Object.defineProperty(a, "_percentage", {
							value : 0,
							writable : true,
							enumerable : false,
							configurable : false});
						
						Object.defineProperty(a, "source", {
							get : function(){return this._parent.source},
							enumerable : true,
							});
						
						Object.defineProperty(a, "unassignied", {
							get : function(){
								if(this !== this._parent.unassignied) return this._parent.unassignied;
								return this;
							},
							enumerable : true,
							configurable : false});
						
						Object.defineProperty(a, "amount", {
							get : function(){return this._amount},
							set : function(a){
								this._percentage = a / this._parent.referenceBudget;
								//don't calculate the unassignied for the unassignied object
								if(this !== this.unassignied){
									this.unassignied.amount += this._amount - a;
								}
								this._amount = a;
								 
							},
							enumerable : true,
							configurable : false});
						
						Object.defineProperty(a, "percentage", {
							get : function(){return this._percentage},
							set : function(a){
								this._amount = this._parent.referenceBudget * a /100;
								
								//don't calculate the unassignied for the unassignied object
								if(this !== this.unassignied){
									this.unassignied.percentage += this._percentage - a;
								}
								this._percentage = a;
								 
							},
							enumerable : true,
							configurable : false});
						//We generate here a random id in order to be able to define a key
						//TODO : use a real unique number
						a.sourceID = Math.random();
						
						
						//if(a.source == "user" && a.id==0) unassignied = a;
						//add the unassignied element to the parent
						if(a.id == 0){
							//init to 100% as after values are removed from unassignied
							a.percent = 100;
							d.unassignied = a;
						}
						
						//object data initialization
						a.percentage = a.percent;
						
					});
				});
				
				var data = [];
				args.forEach(function(arr,i){
					arr.data.reduce(function(p,c){
						var i = p.lazyIndexOf(function(a,b){
								return a.lazyIndexOf(function(x,y){
									return x.id == y.id}
								,b) != -1;
							},c); 
						if(i != -1){
							p[i].push(c);
						}else{
							p.push([c]);
						}
						return p;
					},data);
					
				});
				
				var margin = {top: 20, right: 20, bottom: 430, left: 40},
					    width = 1060 - margin.left - margin.right,
					    height = 900 - margin.top - margin.bottom;
				
				var svg = d3.select("body #g2").append("svg")
						    .attr("width", width + margin.left + margin.right)
						    .attr("height", height + margin.top + margin.bottom)
						  .append("g")
						    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
				
				var x0 = d3.scale.ordinal()
			    .rangeRoundBands([0, width], .1);

				var x1 = d3.scale.ordinal();
	
				var y = d3.scale.linear()
				    .range([height, 0]);
	
				var color = d3.scale.ordinal()
				    .range(["#98abc5", "#ff8c00","#8a89a6", "#7b6888", "#6b486b", "#a05d56", "#d0743c"]);
	
				var xAxis = d3.svg.axis()
				    .scale(x0)
				    .orient("bottom");
	
				var yAxis = d3.svg.axis()
				    .scale(y)
				    .orient("left")
				    .tickFormat(d3.format(".2s"));
				
				
				
				function displayBar(data,svg,printAxes){
				
					function budgetId(d){
						//@TODO : see why this number generation
// 						return d.sourceID+d.amount/100000;
						//or a string id generation don't work
// 						return d.sourceID+"_"+d.amount+"_"+d.source;
						return Math.random();
					}
					  
					function getHeight(d){
						return height - y(d.amount);
					}
					
					function printAxis(){
						 svg.append("g")
					      .attr("class", "x axis")
					      .attr("transform", "translate(0," + height + ")")
					      .call(xAxis)
					      .selectAll("text")
						    .attr("y", 0)
						    .attr("x", -10)
						    .attr("dy", ".35em")
						    .attr("transform", "rotate(-75)")
						    .style("text-anchor", "end");
					      ;

					  svg.append("g")
					      .attr("class", "y axis")
					      .call(yAxis)
					    .append("text")
					      .attr("transform", "rotate(-90)")
					      .attr("y", 6)
					      .attr("dy", ".71em")
					      .style("text-anchor", "end")
					      .text("Amount");
					}
					  
					  var ageNames = [];
					  args.forEach(function(p,i){
						  ageNames.push(p.source);
					  });
					  
					  x0.domain(data.map(function(d) { return d[0].label; }));
					  x1.domain(ageNames).rangeRoundBands([0, x0.rangeBand()]);
					  y.domain([0, d3.max(data, function(d) { return d3.max(data, function(arr){ 
						  return d3.max(arr,function(d) { return d.amount; })
					  }); })]);
		
					 if(printAxes) printAxis();
					  
					  var state = svg.selectAll("g.budgetLine")
					      .data(data,function(d){
					    	  //console.log(d.reduce(function(p,c){ return p+"|"+budgetId(c); },""));
					    	  return d.reduce(function(p,c){ return p+"|"+budgetId(c); },"");
					    	  //return Math.random();
					      });
					  
					  state.exit().remove();
					  
					  var newState = state.enter().append("g")
					      .attr("class", "budgetLine")
					      .attr("transform", function(d) { 
					    	  return "translate(" + x0(d[0].label) + ",0)"; });

					var bars = state.selectAll("rect.bar")
					      .data(function(d,i) {
					    	  return d.map(function(v) { return v; }); 
					    	}, function(d){
					    		return budgetId(d);
					    	})
					    ;
	
					var t = bars.enter();
					bars.enter().append("rect")
						  .attr("class","bar")
					      .attr("width", x1.rangeBand())
					      .attr("x", function(d) { 
					    	  return x1(d.source); })
					      .attr("y", function(d) { 
					    	  return y(d.amount); })
					      .attr("height", function(d) { 
					    	  return getHeight(d); })
					      .style("fill", function(d) { return color(d.source); });
					
					bars.exit().remove();
					
					var buttonHeight = 15;
					var pixelValue;
					var starty;
					var startValue;
					var previousValue;
					var maxValue;
					
					var drag = d3.behavior.drag()
							    .on("dragstart",function(d){
							    	starty =  +d3.select(this).attr("y") + buttonHeight;
							    	pixelValue = d.amount / getHeight(d);
							    	startValue = d.amount;
							    	previousValue = d.amount;
							    	maxValue = d.amount + d.unassignied.amount;
							    	
							    	console.group("Init parameters");
							    	console.log("H : " + getHeight(d));
							    	console.log("startY : " + starty);
							    	console.log("pixelValue : " + pixelValue);
							    	console.log("startValue : " + startValue);
							    	console.log("maxValue : " + maxValue);
							    	console.groupEnd();
							    	
							    	
							    })
							    .on("drag", dragmove)
								.on("dragend",function(d){
									
									displayBar(data,svg);
									//unassignied.amount += previousValue - d.amount;
								})
								;
					
					var buttons = state.selectAll("rect.button")
				      .data(function(d,i) {
				    	  return d.reduce(function(p,c) { if (c.source == "user" && c.id != 0) p.push(c); return p; },[]);
				    	}, function(d){
				    		return budgetId(d);
				    	})
				    .enter();
					
					buttons.append("rect")
					  .attr("class","button")
				      .attr("width", x1.rangeBand())
				      .attr("x", function(d) { 
				    	  return x1(d.source); })
				      .attr("y", function(d) { 
				    	  return y(d.amount) - buttonHeight ; })
				      .attr("height", function(d) { 
				    	  return buttonHeight; })
				      .style("fill", function(d) { return "#a05d56"; })
				      .attr("cursor","ns-resize")
				      //drag and drop related
				      .call(drag);			      
				      ;
					
				      function dragmove(d) {
				    	  
				    	  function amountFromPosition(y){
				    		  return startValue + (starty - y - buttonHeight)*pixelValue;
				    	  }
				    	  
				    	  var amount = amountFromPosition(d3.event.y);
				    	  console.group("Drag parameters");
				    	  console.log(amount);
				    	  console.log(unassignied);
				    	  console.log(previousValue);
				    	  console.groupEnd();
				    	  console.warn(amount >= 0 && amount <= maxValue);
				    	  if(amount >= 0 && amount <= maxValue){
				    		  d3.select(this).attr("y", d.y = d3.event.y);
					    	  d.amount = amount;
				    	  }
				    	  
				    	}
		
					  var legend = svg.selectAll(".legend")
					      .data(ageNames.slice().reverse())
					    .enter().append("g")
					      .attr("class", "legend")
					      .attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });
		
					  legend.append("rect")
					      .attr("x", width - 18)
					      .attr("width", 18)
					      .attr("height", 18)
					      .style("fill", color);
		
					  legend.append("text")
					      .attr("x", width - 24)
					      .attr("y", 9)
					      .attr("dy", ".35em")
					      .style("text-anchor", "end")
					      .text(function(d) { return d; });
					
				}
				
				displayBar(data,svg,true);
			
				
			}
			
			
			var realReferenceBudget = "378440180000"; //378 billions
			var userReferenceBudget = taxAmount;
			
			//var ref = realReferenceBudget;
			var ref = userReferenceBudget;
			
			print( {data : dataInit, source : "state",referenceBudget : ref}
					,{data : dataInit2, source : "user", referenceBudget : ref}
// 					,{data : dataInit3, source : "allpeople"}
					);
			
	    
			var o = {
				get amount(){
					console.log("The get");
					return "YOOYOYO3";
				}	
			};
		
			console.log(o.amount);
			
			var t = {
					amount : 15,
					percentage : 10
			}
			
			Object.defineProperty(t, "am", {get : function(){ 
					console.log(this.amount);			
					return this.amount*15; },
                							//set : function(newValue){ percentage = "ZOBI"; },
							                enumerable : true,
							                configurable : true});
			/*t.am = get(){
				return "dmqlkjsdfmlk";
			}*/
			
			console.log(t.am);
			t.amount = 12;
			console.log(t.am);
			t.am = 15;
			
// 			tt;
			
			
		});

		
	    		
	    	console.warn("remove this, as it's test");
	    	
    		$("#taxamount").attr("value",800);
    		$("#valid").click();
	    		    		
	    	});	
	    </script>
  	</head>
 	<body>
 		<h1>Screen 1 : enter your annual tax amount</h1>
 		<p>your Name : <input type="text" id="name"/></p>
 		<p>your annual tax amount : <input type="number" id="taxamount"></input></p>
 		<p><input type="button" id="valid" value="GO!"> </input></p>
 		
 		<div id="hiden" style="display:none">
	 		<h1>Screen 2 : See what do politicians with</h1>
	 		<div class="chart"></div>
	 		
	 		<h1>Screen 3 : Tell politiciant what you would like they do with</h1>
	 		<div class="chart2" ></div>
	 		
	 		<h1>Screen 4 : See what others have suggest to politicians</h1>
 		</div>
 		<h1>GRAPH 1</h1>
 		<div id="g1"></div>
 		<h2>GRAPH2</h2>
 		<div id="g2"></div>
	</body>
	
	<div id="dialog-form" title="Change value" style="display:none">
		<form>
			<fieldset>
			<label for="newvalue">Your value</label>
			<input type="text" name="newvalue" id="newvalue" class="text ui-widget-content ui-corner-all">
			</fieldset>
		</form>
	</div>
</html>