<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
    	<title>Your public money in your hand</title>
	    
	    <link rel="icon" type="image/x-icon" href="../resources/images/favicon.ico" />
	    
	    
		<link rel="stylesheet" type="text/css" media="all" href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css" />
		
	    <!-- header and footer -->
		<style type="text/css" title="currentStyle">
		    @import "resources/css/demo_table.css";
			@import "resources/css/propertiesDisplay.css";
		</style>
	    
	    <style type="text/css">
			.chart div {
			  font: 10px sans-serif;
			  background-color: steelblue;
			  text-align: right;
			  padding: 3px;
			  margin: 1px;
			  color: white;
			}
			
				.chart2 div {
			  font: 10px sans-serif;
			  background-color: steelblue;
			  text-align: right;
			  padding: 3px;
			  margin: 1px;
			  color: white;
			}
					  
				.chart2 div.my {
			  background-color: green;
			}
			
			.chart2 div.state {
			  background-color: steelblue;
			}	  	  
	    </style>
	    
	    <link rel="stylesheet" type="text/css" href="resources/css/style.css" />
	    
		<!-- End styles -->
		
		<script type="text/javascript" src="resources/js/array.js"></script>
		
		<script type="text/javascript" src="http://d3js.org/d3.v3.min.js"></script>
		
	    <!-- TODO: extract commons libs from import -->
	    <script type="text/javascript" src="resources/js/libs/jquery-1.7.1.min.js"></script>
	    <script type="text/javascript" src="http://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>
	    
	    <!-- select2 dependencies -->
		<script type="text/javascript" src="resources/js/libs/select2/select2.js"></script>
		<link rel="stylesheet" href="resources/js/libs/select2/select2.css" type="text/css" media="screen" />
		
		<!-- mock datas -->
		<script type="text/javascript" src="./data/rawData.js"></script>
		<script type="text/javascript" src="./data/dataInit.js"></script>
		<script type="text/javascript" src="./data/dataInit2.js"></script>
		<script type="text/javascript" src="./data/dataInit3.js"></script>
	    
	    <script type="text/javascript">
	    	$(document).ready(function(){
	    		
	    		var taxAmount;
	    		var x;
	    		
	    		$("#valid").click(function(){
	    			taxAmount = +$("#taxamount").attr("value");
	    			
	    			var valuesdata = [];
		    		rawData.lines.forEach(function(d){
		    			valuesdata.push(d.amount);
		    		})
		    		
		    		var data = rawData.lines;
		    		
		    		var x = d3.scale.linear()
	    		    .domain([0, d3.max(data,function(d) { 
	    		    	return taxAmount*d.percentage; })]) //TODO : use accessor function
	    		    .range([0, 420]);
	    		    
	    		    
	    		    
	    		    
	    			disp();
	    			
	    			function disp(){
		    			
		    			
		    			
			    		d3.select(".chart")
			    		  .selectAll("div")
			    		    .data(data)
			    		  .enter().append("div")
			    		    .style("width", function(d) { return x(taxAmount*d.percentage) + "px"; })
			    		    .text(function(d) { return d.label; });
			    		
						$("#hiden").show();
		    		}
		    		
		    		
		    		
		    		//part 2
		    		
		    		
		    		
		    		var dataUser = [];
		    		data.forEach(function(d,i){
		    			var duser = dataInit[i];
		    			duser.user = true;
		    			dataUser.push(d);
		    			dataUser.push(duser);
		    		});
		    		
		    		displayChart();
		    		
		    		function displayChart(){
		    			d3.select(".chart2")
			    		  .selectAll("div")
			    		    .data(dataUser)
			    		  .enter().append("div")
			    		    .style("width", function(d) { return x(taxAmount*d.percentage) + "px"; })
			    		    .text(function(d) { return d.label; })
			    			.attr("class",function(d){
			    				return d.user ? "my" :"state";
			    			})
			    			.on("click",function(d){
			    				
			    				$("#newvalue").attr("value", d.amount*d.percentage);
			    				
			    				 $( "#dialog-form" ).dialog({
			    					 autoOpen: false,
			    					 height: 300,
			    					 width: 350,
			    					 modal: true,
			    					 buttons: {
			    					 "valid": function() {
			    						 d.amount = $("#newvalue").val()*1/d.percentage;
				    					 $( this ).dialog( "close" );
				    					 displayChart();
			    					 },
			    					 Cancel: function() {
			    						 $( this ).dialog( "close" );
			    					 },
			    					 close: function() {
			    					 	allFields.val( "" ).removeClass( "ui-state-error" );
			    					 }
			    					 } 
			    				 });
			    				 
			    				 $( "#dialog-form" ).dialog( "open" );
			    				 
			    			})
			    			;
		    		}
		    		
	    			
	    		///**************************************
	    		//**************** Original version
	    		
	    		var margin = {top: 20, right: 20, bottom: 30, left: 40},
	    	    width = 960 - margin.left - margin.right,
	    	    height = 500 - margin.top - margin.bottom;

	    	var x0 = d3.scale.ordinal()
	    	    .rangeRoundBands([0, width], .1);

	    	var x1 = d3.scale.ordinal();

	    	var y = d3.scale.linear()
	    	    .range([height, 0]);

	    	var color = d3.scale.ordinal()
	    	    .range(["#98abc5", "#8a89a6", "#7b6888", "#6b486b", "#a05d56", "#d0743c", "#ff8c00"]);

	    	var xAxis = d3.svg.axis()
	    	    .scale(x0)
	    	    .orient("bottom");

	    	var yAxis = d3.svg.axis()
	    	    .scale(y)
	    	    .orient("left")
	    	    .tickFormat(d3.format(".2s"));

	    	var svg = d3.select("body #g1").append("svg")
	    	    .attr("width", width + margin.left + margin.right)
	    	    .attr("height", height + margin.top + margin.bottom)
	    	  .append("g")
	    	    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
	    	
	    	var dfd = $.Deferred();
	    	

	    	d3.csv("data.txt", function(error, data) {
	    	  var ageNames = d3.keys(data[0]).filter(function(key) { return key !== "State"; });

	    	  data.forEach(function(d) {
	    	    d.ages = ageNames.map(function(name) { return {name: name, value: +d[name]}; });
	    	  });

	    	  x0.domain(data.map(function(d) { return d.State; }));
	    	  x1.domain(ageNames).rangeRoundBands([0, x0.rangeBand()]);
	    	  y.domain([0, d3.max(data, function(d) { return d3.max(d.ages, function(d) { return d.value; }); })]);

	    	  svg.append("g")
	    	      .attr("class", "x axis")
	    	      .attr("transform", "translate(0," + height + ")")
	    	      .call(xAxis);

	    	  svg.append("g")
	    	      .attr("class", "y axis")
	    	      .call(yAxis)
	    	    .append("text")
	    	      .attr("transform", "rotate(-90)")
	    	      .attr("y", 6)
	    	      .attr("dy", ".71em")
	    	      .style("text-anchor", "end")
	    	      .text("Population");

	    	  var state = svg.selectAll(".state")
	    	      .data(data)
	    	    .enter().append("g")
	    	      .attr("class", "g")
	    	      .attr("transform", function(d) { return "translate(" + x0(d.State) + ",0)"; });

	    	  state.selectAll("rect")
	    	      .data(function(d) { 
	    	    	  return d.ages; })
	    	    .enter().append("rect")
	    	      .attr("width", x1.rangeBand())
	    	      .attr("x", function(d) { return x1(d.name); })
	    	      .attr("y", function(d) { return y(d.value); })
	    	      .attr("height", function(d) { return height - y(d.value); })
	    	      .style("fill", function(d) { return color(d.name); });

	    	  var legend = svg.selectAll(".legend")
	    	      .data(ageNames.slice().reverse())
	    	    .enter().append("g")
	    	      .attr("class", "legend")
	    	      .attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });

	    	  legend.append("rect")
	    	      .attr("x", width - 18)
	    	      .attr("width", 18)
	    	      .attr("height", 18)
	    	      .style("fill", color);

	    	  legend.append("text")
	    	      .attr("x", width - 24)
	    	      .attr("y", 9)
	    	      .attr("dy", ".35em")
	    	      .style("text-anchor", "end")
	    	      .text(function(d) { return d; });
	    	  
	    	  dfd.resolve();
	    	});


	///**************************************
	    		//**************** Personnal version
	    		
		$.when(dfd.promise()).then(function(){
			
			
			function print( /* {data : d, source : "sourceName"}*/){
				
				var args = Array.slice(arguments);

				//data transformation add the source attribute to objects
				args.forEach(function(d,i){
					d.data.forEach(function(a,j){
						a.source = d.source;
						//a.sourceID = i;
						
						//We generate here a random id in order to be able to define a key
						//TODO : use a real unique number
						a.sourceID = Math.random();
					});
				});
				
				var data = [];
				args.forEach(function(arr,i){
					arr.data.reduce(function(p,c){
						var i = p.lazyIndexOf(function(a,b){
								return a.lazyIndexOf(function(x,y){
									return x.id == y.id}
								,b) != -1;
							},c); 
						if(i != -1){
							p[i].push(c);
						}else{
							p.push([c]);
						}
						return p;
					},data);
					
				});
				
				var margin = {top: 20, right: 20, bottom: 30, left: 40},
					    width = 960 - margin.left - margin.right,
					    height = 500 - margin.top - margin.bottom;
				
				var svg = d3.select("body #g2").append("svg")
						    .attr("width", width + margin.left + margin.right)
						    .attr("height", height + margin.top + margin.bottom)
						  .append("g")
						    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
				
				var x0 = d3.scale.ordinal()
			    .rangeRoundBands([0, width], .1);

				var x1 = d3.scale.ordinal();
	
				var y = d3.scale.linear()
				    .range([height, 0]);
	
				var color = d3.scale.ordinal()
				    .range(["#98abc5", "#ff8c00","#8a89a6", "#7b6888", "#6b486b", "#a05d56", "#d0743c"]);
	
				var xAxis = d3.svg.axis()
				    .scale(x0)
				    .orient("bottom");
	
				var yAxis = d3.svg.axis()
				    .scale(y)
				    .orient("left")
				    .tickFormat(d3.format(".2s"));
				
				
				
				function displayBar(data,svg){
				
					function budgetId(d){
						//TODO : see why this number generation
// 						return d.sourceID+d.amount/100000;
						//or a string id generation don't work
// 						return d.sourceID+"_"+d.amount+"_"+d.source;
						return Math.random();
					}
					  
					function getHeight(d){
						return height - y(d.amount);
					}
					  //data = rawData.lines;
					  
					  //TODO : manage this dynamically
					  var ageNames = [];//["state","user"];
					  args.forEach(function(p,i){
						  ageNames.push(p.source);
					  });
					  
					  x0.domain(data.map(function(d) { return d[0].id; }));
					  x1.domain(ageNames).rangeRoundBands([0, x0.rangeBand()]);
					  y.domain([0, d3.max(data, function(d) { return d3.max(data, function(arr){ 
						  return d3.max(arr,function(d) { return d.amount; })
					  }); })]);
		
					  svg.append("g")
					      .attr("class", "x axis")
					      .attr("transform", "translate(0," + height + ")")
					      .call(xAxis);

					  svg.append("g")
					      .attr("class", "y axis")
					      .call(yAxis)
					    .append("text")
					      .attr("transform", "rotate(-90)")
					      .attr("y", 6)
					      .attr("dy", ".71em")
					      .style("text-anchor", "end")
					      .text("Amount");
					  
					  var state = svg.selectAll("g.budgetLine")
					      .data(data,function(d){
					    	  //console.log(d.reduce(function(p,c){ return p+"|"+budgetId(c); },""));
					    	  return d.reduce(function(p,c){ return p+"|"+budgetId(c); },"");
					    	  //return Math.random();
					      });
					  
					  state.exit().remove();
					  
					  var newState = state.enter().append("g")
					      .attr("class", "budgetLine")
					      .attr("transform", function(d) { 
					    	  return "translate(" + x0(d[0].id) + ",0)"; });

					var bars = state.selectAll("rect.bar")
					      .data(function(d,i) {
					    	  return d.map(function(v) { return v; }); 
					    	}, function(d){
					    		return budgetId(d);
					    	})
					    ;
	
					var t = bars.enter();
					bars.enter().append("rect")
						  .attr("class","bar")
					      .attr("width", x1.rangeBand())
					      .attr("x", function(d) { 
					    	  return x1(d.source); })
					      .attr("y", function(d) { 
					    	  return y(d.amount); })
					      .attr("height", function(d) { 
					    	  return getHeight(d); })
					      .style("fill", function(d) { return color(d.source); });
					
					bars.exit().remove();
					
					var buttonHeight = 15;
					var pixelValue;
					var starty;
					var startValue;
					
					var drag = d3.behavior.drag()
							    .on("dragstart",function(d){
							    	starty =  +d3.select(this).attr("y") + buttonHeight;
							    	console.warn("start");
							    	console.debug(getHeight(d));
							    	pixelValue = d.amount / getHeight(d);
							    	startValue = d.amount;
							    })
							    .on("drag", dragmove)
								.on("dragend",function(){
									displayBar(data,svg);
									
								})
								;
					
					var buttons = state.selectAll("rect.button")
				      .data(function(d,i) {
				    	  return d.reduce(function(p,c) { if (c.source == "user") p.push(c); return p; },[]);
				    	}, function(d){
				    		return budgetId(d);
				    	})
				    .enter();
					
					buttons.append("rect")
					  .attr("class","button")
				      .attr("width", x1.rangeBand())
				      .attr("x", function(d) { 
				    	  return x1(d.source); })
				      .attr("y", function(d) { 
				    	  return y(d.amount) - buttonHeight ; })
				      .attr("height", function(d) { 
				    	  return buttonHeight; })
				      .style("fill", function(d) { return "#a05d56"; })
				      .attr("cursor","ns-resize")
				      //drag and drop related
				      .call(drag);			      
				      ;
					
				      function dragmove(d) {
				    	  d3.select(this)
			    	      		.attr("y", d.y = d3.event.y);
				    	  d.amount = startValue + (starty - d.y - buttonHeight)*pixelValue;
				    	}
		
					  var legend = svg.selectAll(".legend")
					      .data(ageNames.slice().reverse())
					    .enter().append("g")
					      .attr("class", "legend")
					      .attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });
		
					  legend.append("rect")
					      .attr("x", width - 18)
					      .attr("width", 18)
					      .attr("height", 18)
					      .style("fill", color);
		
					  legend.append("text")
					      .attr("x", width - 24)
					      .attr("y", 9)
					      .attr("dy", ".35em")
					      .style("text-anchor", "end")
					      .text(function(d) { return d; });
					
				}
				
				displayBar(data,svg);
			
				
			}
			
			print( {data : dataInit, source : "state"}
					,{data : dataInit2, source : "user"}
// 					,{data : dataInit3, source : "allpeople"}
					);
			
	    
		
		});

		});
	    		
	    	console.warn("remove this, as it's test");
	    	
    		$("#taxamount").attr("value",800);
    		$("#valid").click();
	    		    		
	    	});
	    </script>
  	</head>
 	<body>
 		<h1>Screen 1 : enter your annual tax amount</h1>
 		<p>your Name : <input type="text" id="name"/></p>
 		<p>your annual tax amount : <input type="number" id="taxamount"></input></p>
 		<p><input type="button" id="valid" value="GO!"> </input></p>
 		
 		<div id="hiden" style="display:none">
	 		<h1>Screen 2 : See what do politicians with</h1>
	 		<div class="chart"></div>
	 		
	 		<h1>Screen 3 : Tell politiciant what you would like they do with</h1>
	 		<div class="chart2" ></div>
	 		
	 		<h1>Screen 4 : See what others have suggest to politicians</h1>
 		</div>
 		<h1>GRAPH 1</h1>
 		<div id="g1"></div>
 		<h2>GRAPH2</h2>
 		<div id="g2"></div>
	</body>
	
	<div id="dialog-form" title="Change value" style="display:none">
		<form>
			<fieldset>
			<label for="newvalue">Your value</label>
			<input type="text" name="newvalue" id="newvalue" class="text ui-widget-content ui-corner-all">
			</fieldset>
		</form>
	</div>
</html>